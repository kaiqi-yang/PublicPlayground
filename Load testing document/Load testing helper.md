# Load testing


## Monitoring

- Container versions dashboard
  - VPN needed
  - https://dashboard.paylater-tools.net/?env=qaload
- New relic qaload performance testing dashboard
  - https://one.nr/06vjA8m55RP
  - Consists of metrics from main qaload services, external entities and infrastructure.


## Step by step guide
1. (optional) start the qaload environment
     - Do I need to start the env?
       - Check the Container versions dashboard listed in the monitoring section, if most of the apps have the desired count as 0 then that means the env needs to be started.
     - Steps
       - Go to pipeline [beta-environments-stop-start](https://buildkite.com/afterpay-paylater/beta-environments-stop-start)
       - Create a new build with `Start qaload` as the message
       - In `Select-Environment`
         - For `Environment` select `Sydney - qaload`
         - For `Action` select `Start`
       - After the build finished, you will be able to see the containers starting up from the Container versions dashboard.
     - why?
       - For saving cost, qaload is in a sleep schedule. So if you are the first one using the environment that day, highly possible that you will need to start the environment.

2. Warm up the environment
   - Steps
     -  Go to pipeline [paylater-loadtesting-runallload](https://buildkite.com/afterpay-paylater/paylater-loadtesting-runallload)
     -  start a new build with `Warm up` as the message
     -  In `Load Test Parameters`
        -  For `Env` select `qaload-high`
        -  For `admin_duration` put in `600`
        -  For `constant_duration` put in `600`
        -  For `ramp` put in `900`
     -  Monitor the progress of the warm up build
   -  Know issues
      -  The `Create Consumer` step might fail after start up. 
         -  You would need to go into the `🐝🐝🐝 Create Consumers` step, and click on `retry` for the `🐝🐝🐝 Run load test` step.
      -  The `🐝🐝🐝 Mobile simulation` step might fail when the build starts.
         -  You would need to go into the `🐝🐝🐝 Mobile simulation` step, and click on `retry` for the `🐝🐝🐝 Run load test` step.
   - Analyzing the results

     - To get the results, you can
        1. Click on the failed step for example: `🐝🐝🐝 Checkout Process`
        2. Expand the failed `🐝🐝🐝 Run load test` step
        3. Scroll the bottom to the end of the log, you will be able to see the failed categories of requests. 
        4. Alternatively you can go to the `Artifacts` tab of the `🐝🐝🐝 Run load test` step and open the file ending with `/index.html`. It will open up a much more detailed report generated by Gatling.
        ![](Get%20the%20results%20for%20a%20build.png)
     - how do I know the result is good or bad?
       - It's normal to see errors in the warm up, so don't panic.
       - As mentioned above, find out the failed categories of request, and have a look at the number of KO vs OK requests. For example if partial of the request failed like following:
          ```
            > V2 - Create checkout               (OK=1194   KO=80    )
          ``` 
          In this case these error are expected, because of the nature of warming up, it's normal to have some failures when the db is cold.
       - But when all request of a particular kind failed, this normally means a connectivity problem or something wrong in the configuration. You should troubleshoot and reach out for help if you need to.
          ```
            > V2 - Create checkout               (OK=0   KO=1200    )
          ``` 
       - If not all request failed, have a look at the new relic performance testing dashboard mentioned from the monitoring section, and have a look at the error patterns for main services like `qaload-api`, `qaload-portal-app`, `qaload-mobile-app`. 
         - It's expected that errors are happening at the start of the test, and then maintain at a lower lever after the environment are ramped up, for example:
           - ![](expected%20example%20of%20error%20pattern%20for%20warm%20up.png)
         - If error rate is hight even after the start of the test, it needs troubleshooting.
           - ![](example%20of%20unexpected%20error%20pattern%20for%20warm%20up.png)
   - why?
     - Mainly because the database needs to be warmed up after started up.
     - In this case we are configuring a high load but takes a long time to ramp up, so the db performance will slowly catch up. 

3. Pre run check
   - version check
     - Ensure QAload env is running the same vesion as current production
   - database restore
   - review flyway scripts

4. Communication
- Block time in the qaload calendar
- Put comments in the qaload channel

5. Running the load test
   - XXXXXX

